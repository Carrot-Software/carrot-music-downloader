# Python Server

## 框架选择

| 类型     | 框架名         |
| -------- | -------------- |
| Web      | Flask          |
| 请求     | requests       |
| 打包工具 | PyInstaller    |
| 爬虫     | beautifulsoup4 |
| 线程池   | threadpool     |
| 加解密   | pycryptodome   |

## 打包
~~~bash
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt
pyinstaller -D -y --clean --distpath ../release -n server main.py
~~~
#### 为什么是-D选项而不是-F？

-F选项创建单文件，原理是会解压到临时文件夹，所以会创建两个进程：一个是主进程，一个是防止崩溃后的临时文件清理进程。而electron关闭服务端子进程的时候，关闭的是清理进程而不是主进程，所以要避免创建两个进程，则不可以使用-F选项

> 可以参考：[Two process instance when i run "exe" which is generated by pyinstaller?](https://github.com/pyinstaller/pyinstaller/issues/2483)
>
> pyinstall参数可参考：https://pyinstaller.readthedocs.io/en/stable/usage.html

## 接口

默认端口：8765

### GET /api/search

#### 功能

搜索歌曲或获取歌单

#### 请求参数（路径参数）

| 请求参数 | 注释     | 取值                                       | 类型 | 示例      |
| -------- | -------- | ------------------------------------------ | ---- | --------- |
| platform | 平台     | Netease / QQ                           | str  | netease   |
| keyword  | 搜索值   | 若为全数字，则为歌单ID；否则为歌曲名或歌手 | str  | 988690134 |
| size     | 结果个数 | 默认值30，取决于对应平台是否支持           | int  | 20        |

#### 响应示例

~~~json
{
    "code": 200,
    "data": [
        {
            "album": "分享", // 专辑
            "id": 156524, // 歌曲ID
            "name": "特别的爱给特别的你", // 歌曲名
            "platform": "netease", // 音乐平台
            "singers": [
                "伍思凯" // 歌手列表
            ]
        },
        ...
    ],
    "msg": "操作成功"
}
~~~

#### 注意事项

歌曲列表前端记得判空，部分字段有可能为null



### POST /api/download

#### 功能

下载歌曲（多线程）

#### 请求参数（请求体）

~~~jso
{
    "song_id_list": ["19292984", "190778"], // 歌曲列表ID
    "platform": "netease", // 音乐平台
    "save_path" : "./song" // 保存位置
}
~~~

#### 响应示例

~~~json
{
    "code": 200,
    "data": null,
    "msg": "操作成功"
}
~~~



### GET /api/history

#### 功能

获取所有下载历史

#### 请求参数

无

#### 响应示例

~~~json
{
    "code": 200,
    "data": [
        {
            "song": {
                "album": "中国梦之声·我们的歌 第12期",
                "id": null,
                "name": "心动 (Live)",
                "singers": [
                    "那英",
                    "肖战"
                ]
            },
            "success": false // 是否成功
        },
        {
            "song": {
                "album": "爱情的尽头",
                "id": null,
                "name": "Last Dance",
                "singers": [
                    "伍佰 & China Blue"
                ]
            },
            "success": true
        }
    ],
    "msg": "操作成功"
}
~~~

### DELETE /api/history

#### 功能

清空下载历史

#### 请求参数

无

#### 响应示例

~~~json
{
    "code": 200,
    "data": null,
    "msg": "操作成功"
}
~~~

